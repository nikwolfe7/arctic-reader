<!DOCTYPE html>
<html>
<head>
<title>Speech & Cognitive Therapy</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<link rel="icon" href="https://raw.githubusercontent.com/twitter/twemoji/master/assets/svg/1f976.svg">
<link rel="stylesheet" href="../stylesheet.css">
<script type="text/javascript" src="../cmu_data.js"></script>
<script type="text/javascript" src="data.js"></script>
<script type="text/javascript">
function getWords(length = 4, number = 5) {
    let request = new XMLHttpRequest();
    let params = `?length=${length}&number=${number}`;
    let url = `https://random-word-api.herokuapp.com/word${params}`;
    request.open("GET", url, false);
    request.send();
    request.onload = () => {
        console.log(request);
        if (request.status === 200) {
            // by default the response comes in the string format, we need to parse the data into JSON
            let result = JSON.parse(request.response);
            console.log(result);
            return result;
        } else {
            console.log(`error ${request.status} ${request.statusText}`);
        }
    }
    // default array. whatever. 
    // return ["boat", "cheese", "dog", "fish", "rocket"]
};
</script>
<script type="text/javascript">
/* image error handling - grab safe index range */
function err(source) {
    let index = Math.floor(Math.random() * 100);
    console.log("picsum 404 error, getting image " + index + " instead.");
    source.src = `https://picsum.photos/id/${index}/600/400`;
    source.onerror = "";
    return true;
}
</script>
<script type="module">

console.log("Loaded Questions array with: " + questions.length + " elements.");	

var i = 0;
var j = 0;

/* Add some images (max id is ~1070)*/
var num_rand_images = 10, width = 600, height = 400, max_images = 1070;
console.log("Sampling " + num_rand_images + " from lorem picsum and appending to questions...");

var rand_images = {
    "title": "Spoken: Describe the image out loud",
    "question_type": "simple",
    "data": getRandomImages(num_rand_images, max_images, width, height)
} 

var sentence_rand_images = {
    "title": "Spoken: Make a sentence for this image",
    "question_type": "simple",
    "data": getRandomImages(num_rand_images, max_images, width, height)
} 

var writing_rand_images = {
    "title": "Written: Describe the image in writing",
    "question_type": "simple",
    "data": getRandomImages(num_rand_images, max_images, width, height)
} 

var describe_hidden_rand_images = {
    "title": "Remember: Look briefly then tap to hide",
    "question_type": "simple",
    "data": getDescriptionImages(num_rand_images, max_images, width, height)
}

questions.push(rand_images);
questions.push(writing_rand_images);
questions.push(sentence_rand_images);
questions.push(describe_hidden_rand_images);


/* Append word memorization task to question set */
var num_word_mem_questions = 5;
while(num_word_mem_questions-- > 0) {
    let word_length = 3, num_words = 5;
    console.log(`getting ${num_words} words...`);
    addWordMemorizationTask(word_length, num_words);
}


/* Append N word memorization + image tasks to question set */
var num_word_img_mem_questions = 5;
while(num_word_img_mem_questions-- > 0) {
    let word_length = 4, num_words = 4;
    console.log(`getting ${num_words} words...`);
    addWordMemorizationPlusImageTask(word_length, num_words);
}


/* Add some artic sentence*/
var num_arctic_sentences = 20;
console.log("Sampling " + num_arctic_sentences + " from arctic dataset and appended to questions.");

var arctic = {
    "title": "Speech: Read Out Loud",
    "question_type": "simple",
    "data": getRandom(arctic_dataset, num_arctic_sentences)
};

questions.push(arctic);

// shuffle our sesh
shuffle(questions);

// initialize
setTextFields();


/* Check bounds of the data array */
function boundsCheck() {
    i = Math.min(Math.max(i, 0), questions.length - 1);
    j = Math.min(Math.max(j, 0), questions[i].data.length - 1);
}


/* Returns a randomly version of array */
function shuffle(array) {
  let currentIndex = array.length,  randomIndex;

  // While there remain elements to shuffle.
  while (currentIndex != 0) {

    // Pick a remaining element.
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}


/* Returns a random subset of array arr of size n */
function getRandom(arr, n) {
    let result = new Array(n),
        len = arr.length,
        taken = new Array(len);
    /* bound check */    
    n = n > len ? len : n;
    while (n--) {
        var x = Math.floor(Math.random() * len);
        result[n] = arr[x in taken ? taken[x] : x];
        taken[x] = --len in taken ? taken[len] : len;
    }
    return result;
}


/* Add a set of random words + image task to the questions set */
function addWordMemorizationPlusImageTask(length = 4, number = 5) {
    // let params = `?length=${length}&number=${number}&lang=en`;
    let params = `?number=${number}&lang=en`;
    let url = `https://random-word-api.herokuapp.com/word${params}`;
    fetch(url)
        .then(function(response) {
            return response.json();
        })
        .then(function(words) {
            console.log(JSON.stringify(words));
            let list_of_words = words.join(' &bull; ');
            let rand_words = {
                "title": "Memorization: Word List + Image",
                "question_type": "simple",
                "data": [
                    "Tap to see a list of words.",
                    list_of_words,
                    "Describe the following image...",
                    getRandomImages(1, max_images, width, height),
                    "Can you recite the list of words?",
                    list_of_words,
                ]
            };
            questions.push(rand_words);
        });
}


/* Add a set of random words to the questions set */
function addWordMemorizationTask(length = 4, number = 5) {
    // let params = `?length=${length}&number=${number}&lang=en`;
    let params = `?number=${number}&lang=en`;
    let url = `https://random-word-api.herokuapp.com/word${params}`;
    fetch(url)
        .then(function(response) {
            return response.json();
        })
        .then(function(words) {
            console.log(JSON.stringify(words));
            let list_of_words = words.join(' &bull; ');
            let rand_words = {
                "title": "Memorization: Word List",
                "question_type": "simple",
                "data": [
                    "Tap to see a list of words.",
                    list_of_words,
                    "Can you recite the list of words?",
                    list_of_words,
                ]
            };
            questions.push(rand_words);
        });
}


/* Returns a random set of images with text prompts */
function getDescriptionImages(num_images, max_index, width, height) {
    let rnd_images = getRandomImages(num_images, max_images, width, height);
    let desc_images = new Array();
    for(let i = 0; i < num_images; i++) {
        let text_prompts = [
            "Tap to see the next image.",
            rnd_images[i],
            "Describe the previous image.",
        ];
        desc_images.push(...text_prompts);
    }
    return desc_images;
}


/* Returns a random set of image URLs from lorem picsum */
function getRandomImages(num_images, max_index, width, height) {
    let indices = Array(max_index).fill().map((element, index) => index);
    let rand_subset = getRandom(indices, num_images);
    for(let i = 0; i < rand_subset.length; ++i) {
        let s = `<img src='https://picsum.photos/id/${rand_subset[i]}/${width}/${height}' onerror='err(this)'/>`;
        rand_subset[i] = s; 
    }
    return rand_subset;
}


function setTextFields() {
    boundsCheck();        
    let title = questions[i].title,
        text = questions[i].data[j];
    
    console.log("Displaying element title " + i + ": " + title);
    console.log("Displaying element text " + j + ": " + text);
    
    document.getElementById('titlebox').innerHTML = title;
    document.getElementById('txtbox').innerHTML = text;
}


function nextQuestion() {
    boundsCheck();
    i = ++i >= questions.length ? 0 : i;
    j = 0;
}


function prevQuestion() {
    boundsCheck();
    i = --i < 0 ? questions.length - 1 : i;
    j = 0;
}


function randQuestion() {
    i = Math.floor(Math.random() * questions.length);
    j = 0;
}


function nextItem() {
    boundsCheck();
    /* data items exceeded, proceed to next question */ 
    if (++j >= questions[i].data.length) {
        nextQuestion();
    }
}

/* Keyboard + laptop */
document.onkeydown = function(e) {
    /* space bar */
    if (e.keyCode == 32) {
        console.log("Space Bar Key Event");
        nextItem();
        setTextFields();
    }
	/* right arrow, or up arrow */
    else if (e.keyCode == 38 || e.keyCode == 39) {
        console.log("Forward Key Event");
        nextQuestion();
        setTextFields();
    }
    /* left arrow or down arrow */
    else if (e.keyCode == 37 || e.keyCode == 40) { // backward
        console.log("Backward Key Event");
        prevQuestion();
        setTextFields();
    }
    /* letter R */
    else if (e.keyCode == 82) { // random
		console.log("Random Key Event");
        randQuestion();
        setTextFields();
    }
}

/* Mobile touch screen */
document.body.addEventListener("touchend", function() {
	console.log("Touch End Event");
	nextItem();
	setTextFields();
});

</script>
</head>
<body>
<div class="container">
    <span id="titlebox" class="title_display"></span>
    <span id="txtbox" class="text_display"></span>
</div>
</body>
</html>